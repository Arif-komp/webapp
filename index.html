<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Otentikasi Gudang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        #app {
            max-width: 480px;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-field {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
        }
        .btn-toggle {
            transition: all 0.3s ease;
        }
        .btn-primary {
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .loader-icon {
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="bg-white shadow-2xl rounded-2xl p-8 md:p-12 w-full">
        <div id="main-content">
            <div id="loader" class="text-center p-6 hidden">
                <div class="loader-icon w-8 h-8 rounded-full border-4 border-gray-200 border-t-indigo-600 mx-auto"></div>
                <p class="text-sm text-gray-500 mt-3 animate-pulse">Memproses...</p>
            </div>

            <div id="auth-view">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-2 text-center" id="auth-title">Masuk ðŸ‘‹</h1>
                <p class="text-center text-gray-500 mb-8">Akses cepat ke sistem manajemen gudang.</p>
                
                <div class="flex justify-center mb-8 bg-gray-100 rounded-xl p-1 shadow-inner">
                    <button id="toggle-signin" class="btn-toggle flex-1 px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-600 text-white shadow-md">Masuk</button>
                    <button id="toggle-signup" class="btn-toggle flex-1 px-4 py-2 text-sm font-semibold rounded-lg text-gray-700 hover:bg-white/70">Daftar</button>
                </div>

                <form id="auth-form" onsubmit="event.preventDefault(); submitAuth();">
                    <div class="mb-5">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="text" id="email" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-1">
                    </div>
                    <div class="mb-8">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password Bebas</label>
                        <input type="password" id="password" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-1">
                    </div>
                    
                    <button type="submit" id="submit-button" class="btn-primary w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/50 hover:bg-indigo-700">Masuk</button>
                </form>

                <div id="message-area" class="mt-6 p-4 rounded-xl text-sm hidden" role="alert"></div>
            </div>
            
            <div id="dashboard-view" class="text-center p-6 hidden transition-opacity duration-500">
                <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.108a9 9 0 11-12.63 12.63l-1.92 1.92-2.83-2.83 1.92-1.92A9 9 0 0120.618 7.892z"></path></svg>
                <h1 class="text-3xl font-extrabold text-indigo-600 mb-2">Akses Disetujui!</h1>
                <p class="text-lg text-gray-700 mb-6">Selamat datang, <span id="user-display-email" class="font-semibold"></span>. Mengalihkan...</p>
            </div>
        </div>
    </div>

    <script>
        // PASTIKAN ANDA MENGGANTI INI DENGAN URL WEB APP GAS ASLI ANDA
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby0u7o9ml5CSyG4qI-6ycMaCgQwuLZS3ZMj7hAxkir-1Svh9Qz1obP21c4q8EA-alO9/exec'; 
        const STORAGE_KEY = 'user_session_approved';
        const CREDENTIALS_KEY = 'last_credentials'; // Key baru untuk menyimpan email/pass

        let isSigningUp = false;
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const authTitle = document.getElementById('auth-title');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');
        const loader = document.getElementById('loader');
        const toggleSignin = document.getElementById('toggle-signin');
        const toggleSignup = document.getElementById('toggle-signup');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        function toggleAuthMode(isSignUpMode) {
            isSigningUp = isSignUpMode;
            authTitle.textContent = isSigningUp ? 'Daftar Akun Baru ðŸš€' : 'Masuk ðŸ‘‹';
            submitButton.textContent = isSigningUp ? 'Daftar Sekarang' : 'Masuk';
            
            const [active, inactive] = isSigningUp ? [toggleSignup, toggleSignin] : [toggleSignin, toggleSignup];
            
            active.classList.remove('text-gray-700', 'hover:bg-white/70');
            active.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
            inactive.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            inactive.classList.add('text-gray-700', 'hover:bg-white/70');
            showMessage(null);
        }

        function showMessage(msg, type = 'error') {
            if (!msg) {
                messageArea.classList.add('hidden');
                return;
            }
            messageArea.textContent = msg;
            messageArea.className = `mt-6 p-4 rounded-xl text-sm transition duration-300 animate-pulse`;
            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                messageArea.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            }
            messageArea.classList.remove('hidden');
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                authView.classList.add('hidden');
                submitButton.disabled = true;
            } else {
                loader.classList.add('hidden');
                authView.classList.remove('hidden');
                submitButton.disabled = false;
            }
        }

        function saveCredentials(email, password) {
            localStorage.setItem(CREDENTIALS_KEY, JSON.stringify({ email: email, password: password }));
        }

        function loadCredentials() {
            const stored = localStorage.getItem(CREDENTIALS_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    emailInput.value = data.email || '';
                    passwordInput.value = data.password || '';
                } catch (e) {
                    console.error("Error parsing stored credentials", e);
                    localStorage.removeItem(CREDENTIALS_KEY);
                }
            }
        }

        async function submitAuth() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const action = isSigningUp ? 'signup' : 'signin';

            if (!email || !password) {
                showMessage('Email dan Kata Sandi harus diisi.');
                return;
            }

            setLoading(true);
            showMessage(null);

            try {
                const dataToSend = { action: action, email: email, password: password };
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(dataToSend).toString()
                });

                if (!response.ok) {
                    throw new Error(`Permintaan API gagal dengan status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    saveCredentials(email, password); // Simpan kredensial setelah sukses
                    
                    if (action === 'signin') {
                        if (result.is_approved) {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify({ email: email, timestamp: Date.now() }));
                            renderDashboard(email);
                        } else {
                            showMessage(`Login berhasil, tetapi status persetujuan Anda adalah: ${result.status_persetujuan || 'Menunggu'}. Harap tunggu persetujuan admin.`, 'warning');
                        }
                    } else if (action === 'signup') {
                        showMessage(result.message, 'success');
                        toggleAuthMode(false); // Kembali ke mode login setelah daftar
                    }
                } else {
                    showMessage(result.message || 'Terjadi kesalahan tidak diketahui. Cek kembali kredensial Anda.');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                showMessage(`Terjadi kesalahan jaringan atau Web App URL salah: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function renderDashboard(userEmail) {
            authView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.getElementById('user-display-email').textContent = userEmail;
            
            // Redirect setelah 1.5 detik
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500); 
        }

        function checkSession() {
            const storedSession = localStorage.getItem(STORAGE_KEY);
            if (storedSession) {
                try {
                    const sessionData = JSON.parse(storedSession);
                    // Langsung tampilkan dashboard view dan redirect
                    renderDashboard(sessionData.email); 
                    return;
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
            
            // Jika tidak ada sesi, tampilkan form login
            dashboardView.classList.add('hidden');
            authView.classList.remove('hidden');
            setLoading(false);
            toggleAuthMode(false);
            loadCredentials(); // Muat kredensial terakhir
        }

        toggleSignin.addEventListener('click', () => toggleAuthMode(false));
        toggleSignup.addEventListener('click', () => toggleAuthMode(true));
        document.addEventListener('DOMContentLoaded', checkSession);

    </script>
</body>
</html>
